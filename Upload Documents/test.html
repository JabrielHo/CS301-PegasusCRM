<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Secure Document Upload</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f5f7fa;
        margin: 0;
        padding: 0;
        color: #333;
      }
      .container {
        max-width: 600px;
        margin: 40px auto;
        padding: 30px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 1px solid #eaeaea;
        padding-bottom: 15px;
      }
      .logo-placeholder {
        width: 40px;
        height: 40px;
        background-color: #0056b3;
        border-radius: 5px;
        margin-right: 15px;
      }
      h1 {
        font-size: 24px;
        margin: 0;
        color: #0056b3;
      }
      .instruction {
        margin-bottom: 20px;
        font-size: 14px;
        line-height: 1.5;
        color: #666;
      }
      .file-upload {
        /* Do not use shorthand property for border */
        border-width: 2px;
        border-style: dashed;
        border-color: #ccc;
        border-radius: 6px;
        padding: 25px;
        text-align: center;
        margin-bottom: 20px;
        cursor: pointer;
        transition: all 0.3s;
        display: block;
        width: auto;
        box-sizing: border-box;
      }
      .file-upload:hover {
        border-color: #0056b3;
        background-color: #f8f9fa;
      }
      .file-upload.active {
        border-color: #28a745;
        background-color: #f0fff4;
      }
      .file-upload input {
        display: none;
      }
      .file-icon {
        font-size: 48px;
        color: #0056b3;
        margin-bottom: 10px;
      }
      .file-info {
        display: none;
        margin-top: 15px;
        padding: 10px;
        background-color: #e9f5ff;
        border-radius: 5px;
        text-align: left;
      }
      .file-name {
        font-weight: bold;
        word-break: break-all;
      }
      .file-size {
        color: #666;
        font-size: 12px;
      }
      .file-type-icon {
        margin-right: 5px;
        color: #0056b3;
      }
      .upload-btn {
        background-color: #0056b3;
        color: white;
        border: none;
        padding: 12px 25px;
        font-size: 16px;
        border-radius: 5px;
        cursor: pointer;
        width: 100%;
        transition: background-color 0.3s;
      }
      .upload-btn:hover {
        background-color: #003d82;
      }
      .upload-btn:disabled {
        background-color: #b3c7d8;
        cursor: not-allowed;
      }
      .status {
        margin-top: 20px;
        padding: 10px;
        border-radius: 5px;
        font-size: 14px;
      }
      .status.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .status.warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
      }
      .status.loading {
        background-color: #e9f5ff;
        color: #0056b3;
        border: 1px solid #b8daff;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .loader {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #0056b3;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        margin-right: 10px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .footer {
        font-size: 12px;
        color: #666;
        text-align: center;
        margin-top: 30px;
        border-top: 1px solid #eaeaea;
        padding-top: 15px;
      }
      .document-type {
        margin-bottom: 20px;
      }
      .document-type select {
        width: 100%;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ddd;
        font-size: 14px;
      }
      .error-message {
        color: #dc3545;
        font-size: 12px;
        margin-top: 5px;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="logo-placeholder"></div>
        <h1>Secure Document Upload</h1>
      </header>

      <div class="instruction">
        <p>
          Please upload the requested document. We accept PDF, PNG, JPG, and
          JPEG files up to 10MB in size.
        </p>
      </div>

      <div class="document-type">
        <select id="documentType">
          <option value="">Select document type</option>
          <option value="identification">Identification (Passport/ID)</option>
          <option value="proofOfAddress">Proof of Address</option>
          <option value="bankStatement">Bank Statement</option>
          <option value="incomeVerification">Income Verification</option>
          <option value="other">Other Documents</option>
        </select>
        <div class="error-message" id="docTypeError">
          Please select a document type
        </div>
      </div>

      <div class="file-upload" id="dropZone">
        <div class="file-icon">ðŸ“„</div>
        <p>Drag and drop your file here or click to browse</p>
        <input type="file" id="fileInput" accept=".pdf,.png,.jpg,.jpeg" />
        <div class="error-message" id="fileError">
          Please select a valid file
        </div>

        <div class="file-info" id="fileInfo">
          <div>
            <span class="file-type-icon">ðŸ“„</span>
            <span class="file-name" id="fileName"></span>
          </div>
          <div class="file-size" id="fileSize"></div>
        </div>
      </div>

      <button class="upload-btn" id="uploadBtn" disabled>
        Upload Document
      </button>

      <div class="status" id="status" style="display: none"></div>

      <div class="footer">
        All uploads are encrypted and securely stored in compliance with banking
        regulations.
        <br />For assistance, please contact our support team.
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
      // DOM Elements
      const fileInput = document.getElementById("fileInput");
      const dropZone = document.getElementById("dropZone");
      const uploadBtn = document.getElementById("uploadBtn");
      const status = document.getElementById("status");
      const fileInfo = document.getElementById("fileInfo");
      const fileName = document.getElementById("fileName");
      const fileSize = document.getElementById("fileSize");
      const documentType = document.getElementById("documentType");
      const fileError = document.getElementById("fileError");
      const docTypeError = document.getElementById("docTypeError");

      // Constants
      const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
      const ALLOWED_FILE_TYPES = [
        "application/pdf",
        "image/png",
        "image/jpeg",
        "image/jpg",
      ];

      // Helper Functions
      function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + " bytes";
        else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + " KB";
        else return (bytes / 1048576).toFixed(1) + " MB";
      }

      function showError(element, message) {
        element.textContent = message;
        element.style.display = "block";
        setTimeout(() => {
          element.style.display = "none";
        }, 3000);
      }

      function validateInputs() {
        let isValid = true;

        // Validate document type
        if (!documentType.value) {
          showError(docTypeError, "Please select a document type");
          isValid = false;
        }

        // Validate file
        if (!fileInput.files[0]) {
          showError(fileError, "Please select a file");
          isValid = false;
        } else {
          const file = fileInput.files[0];

          // Check file type
          if (!ALLOWED_FILE_TYPES.includes(file.type)) {
            showError(
              fileError,
              "Invalid file type. Please upload PDF, PNG, or JPG file"
            );
            isValid = false;
          }

          // Check file size
          if (file.size > MAX_FILE_SIZE) {
            showError(fileError, "File is too large. Maximum size is 10MB");
            isValid = false;
          }
        }

        uploadBtn.disabled = !isValid;
        return isValid;
      }

      function showStatus(message, type = "") {
        status.textContent = "";
        status.className = "status";

        if (type === "loading") {
          const loader = document.createElement("div");
          loader.className = "loader";
          status.classList.add("loading");
          status.appendChild(loader);
          status.appendChild(document.createTextNode(" " + message));
        } else {
          status.textContent = message;
          if (type) status.classList.add(type);
        }

        status.style.display = "block";
      }

      function getFileExtension(fileType) {
        const fileTypes = {
          "application/pdf": "pdf",
          "image/png": "png",
          "image/jpeg": "jpg",
          "image/jpg": "jpg",
        };
        return fileTypes[fileType] || "txt"; // Default to "txt" if type is unrecognized
      }

      function handleFile(file) {
        if (!file) return;

        // Update file info display
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        fileInfo.style.display = "block";
        dropZone.classList.add("active");

        validateInputs();
      }

      // Parse the presigned URL securely
      async function getPresignedUrl(file) {
        try {
          const url = new URL(window.location.href);
          const clientId = url.searchParams.get("id");

          if (!clientId) {
            throw new Error("Client ID not found in URL");
          }

          // const filename = file.name;
          const fileType = file.type;
          const ext = getFileExtension(fileType);
          const filename = `${documentType.value}.${ext}`;
          console.log("File type:", fileType);
          console.log(documentType.value);
          // Make POST request to the backend to generate presigned URL
          const response = await axios.post(
            `http://127.0.0.1:5001/clients/${clientId}/presigned_url`,
            {
              filename: filename,
              content_type: fileType,
            }
          );

          if (response.data && response.data.link) {
            return response.data.link; // Return the presigned URL
          } else {
            throw new Error("Failed to get presigned URL");
          }
        } catch (error) {
          console.error(
            "Error fetching presigned URL:",
            error.response ? error.response.data : error
          );
          return null;
        }
      }

      // Event Listeners
      fileInput.addEventListener("change", () => {
        handleFile(fileInput.files[0]);
      });

      documentType.addEventListener("change", validateInputs);

      // Drag and drop functionality
      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("active");
      });

      dropZone.addEventListener("dragleave", () => {
        if (!fileInput.files[0]) {
          dropZone.classList.remove("active");
        }
      });

      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        if (e.dataTransfer.files.length) {
          fileInput.files = e.dataTransfer.files;
          handleFile(fileInput.files[0]);
        }
      });

      dropZone.addEventListener("click", () => {
        fileInput.click();
      });

      // Upload functionality
      uploadBtn.addEventListener("click", async () => {
        if (!validateInputs()) {
          return;
        }

        const file = fileInput.files[0];
        const docType = documentType.value;

        // Fetch the presigned URL asynchronously
        const presignedUrl = await getPresignedUrl(file);

        if (!presignedUrl) {
          return;
        }

        // Disable the button during upload
        uploadBtn.disabled = true;
        showStatus("Uploading your document. Please wait...", "loading");

        try {
          // Add document type and security token as metadata
          const res = await axios.put(presignedUrl, file, {
            headers: {
              "Content-Type": file.type,
            },
          });

          if (res.status === 200) {
            showStatus(
              "Document uploaded successfully! Our team will review it shortly.",
              "success"
            );

            // Reset the form
            setTimeout(() => {
              fileInput.value = "";
              documentType.value = "";
              fileInfo.style.display = "none";
              dropZone.classList.remove("active");
              uploadBtn.disabled = true;
            }, 3000);
          } else {
            console.error("Upload failed:", res.data);
            showStatus(
              "Upload failed. Please try again or contact support.",
              "error"
            );
          }
        } catch (error) {
          console.error("Error during upload:", error);
          showStatus(
            "Network error. Please check your connection and try again.",
            "error"
          );
        } finally {
          uploadBtn.disabled = false;
        }
      });
    
    </script>
    
  </body>
</html>
